---
export interface Props {
	src: string;
	poster?: string;
	title?: string;
	description?: string;
	autoplay?: boolean;
	controls?: boolean;
	loop?: boolean;
	muted?: boolean;
	className?: string;
	aspectRatio?: "video" | "square" | "wide" | "portrait";
	showPlayButton?: boolean;
	preload?: "auto" | "metadata" | "none";
}

const {
	src,
	poster,
	title,
	description,
	autoplay = false,
	controls = true,
	loop = true,
	muted = true,
	className = "",
	aspectRatio = "video",
	showPlayButton = true,
	preload = "metadata",
} = Astro.props;

const aspectClasses = {
	video: "aspect-video",
	square: "aspect-square",
	wide: "aspect-[21/9]",
	portrait: "aspect-[9/16]",
};

const videoId = `video-${Math.random().toString(36).substr(2, 9)}`;
---

<div class={`video-player-wrapper relative group ${className}`}>
	<div
		class={`relative ${aspectClasses[aspectRatio]} bg-black rounded-xl overflow-hidden`}
	>
		<!-- Video Element -->
		<video
			id={videoId}
			src={src}
			poster={poster}
			autoplay={autoplay}
			controls={controls}
			loop={loop}
			muted={muted}
			playsinline
			preload={preload}
			class="w-full h-full object-cover transition-opacity duration-300"
		>
			Your browser does not support the video tag.
		</video>

		<!-- Custom Play Button Overlay (only shows when showPlayButton is true and not autoplaying) -->
		{
			showPlayButton && !autoplay && (
				<div
					class="play-button-overlay absolute inset-0 flex items-center justify-center bg-black/40 backdrop-blur-sm transition-all duration-300 cursor-pointer z-10 pointer-events-auto"
					data-video-id={videoId}
				>
					<button
						class="play-button bg-white/95 hover:bg-white text-black rounded-full p-8 md:p-10 transform hover:scale-110 transition-all duration-300 shadow-2xl pointer-events-auto"
						aria-label="Play video"
					>
						<svg
							class="w-16 h-16 md:w-20 md:h-20 ml-1"
							fill="currentColor"
							viewBox="0 0 20 20"
						>
							<path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z" />
						</svg>
					</button>
				</div>
			)
		}

		<!-- Loading Indicator -->
		<div
			class="loading-indicator absolute inset-0 flex items-center justify-center bg-black/50 opacity-0 transition-opacity duration-300 pointer-events-none"
			data-video-id={videoId}
		>
			<div
				class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-white"
			>
			</div>
		</div>

		<!-- Gradient Overlay for Better Text Readability (optional, shown when title exists) -->
		{
			(title || description) && (
				<div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent p-6 pointer-events-none">
					{title && (
						<h3 class="text-white text-xl md:text-2xl font-bold mb-2">
							{title}
						</h3>
					)}
					{description && (
						<p class="text-gray-200 text-sm md:text-base line-clamp-2">
							{description}
						</p>
					)}
				</div>
			)
		}
	</div>
</div>

<script>
	// Initialize all video players on the page
	function initVideoPlayers() {
		const playOverlays = document.querySelectorAll(".play-button-overlay");

		playOverlays.forEach((overlay) => {
			const videoId = overlay.getAttribute("data-video-id");
			if (!videoId) return;

			const video = document.getElementById(videoId) as HTMLVideoElement;
			const loadingIndicator = document.querySelector(
				`.loading-indicator[data-video-id="${videoId}"]`,
			) as HTMLElement;

			if (!video || !loadingIndicator) return;

			// Handle play button click
			overlay.addEventListener("click", () => {
				if (video.paused) {
					video.muted = false; // Unmute when user clicks play
					video.play();
					// Immediately hide the overlay completely
					overlay.style.display = "none";
				}
			});

			// Ensure overlay hides when video starts playing
			video.addEventListener("play", () => {
				overlay.style.display = "none";
			});

			// Show loading indicator when video is loading
			video.addEventListener("waiting", () => {
				loadingIndicator.classList.remove("opacity-0");
			});

			video.addEventListener("playing", () => {
				loadingIndicator.classList.add("opacity-0");
			});

			video.addEventListener("canplay", () => {
				loadingIndicator.classList.add("opacity-0");
			});

			// Handle video pause - show play button again
			video.addEventListener("pause", () => {
				if (!video.ended) {
					overlay.style.display = "flex";
				}
			});

			// Handle video end - show play button again
			video.addEventListener("ended", () => {
				overlay.style.display = "flex";
			});
		});
	}

	// Initialize on page load
	if (document.readyState === "loading") {
		document.addEventListener("DOMContentLoaded", initVideoPlayers);
	} else {
		initVideoPlayers();
	}
</script>

<style>
	.video-player-wrapper video {
		object-fit: cover !important;
	}

	.video-player-wrapper video::-webkit-media-controls-panel {
		background: linear-gradient(to bottom, transparent, rgba(0, 0, 0, 0.7));
	}

	.play-button {
		filter: drop-shadow(0 4px 20px rgba(0, 0, 0, 0.3));
	}

	.line-clamp-2 {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
</style>
