---
import RootLayout from "../layouts/RootLayout.astro";
import VideoPlayer from "../components/VideoPlayer.astro";
import { getAllMedia, getPhotos, getVideos, getFirstMediaPerProject, type NotionMedia } from "../lib/notion";
import { Image, Video, Grid3x3, Layers } from "lucide-astro";

// Fetch all media at build time
let allMedia: NotionMedia[] = [];
let photos: NotionMedia[] = [];
let videos: NotionMedia[] = [];
let error: string | null = null;

try {
	const [allMediaRaw, photosRaw, videosRaw] = await Promise.all([
		getAllMedia(),
		getPhotos(),
		getVideos(),
	]);

	// Filter to show only first media item per project
	allMedia = getFirstMediaPerProject(allMediaRaw);
	photos = getFirstMediaPerProject(photosRaw);
	videos = getFirstMediaPerProject(videosRaw);
} catch (e) {
	console.error("Failed to fetch media for gallery:", e);
	error = "Failed to load media. Please try again later.";
}

// Get unique tags from all media
const allTags = Array.from(
	new Set(allMedia.flatMap((item) => item.tags || []))
).sort();
---

<RootLayout
	title="Gallery | sudo.create"
	description="Explore our complete collection of photography and video work. Every frame tells a story, every moment captured with intention."
	keywords="photography gallery, video portfolio, creative work, visual storytelling, cinematic photography, professional videography"
>
	<!-- Hero Section -->
	<section class="relative z-10 pt-32 pb-16 px-6">
		<div class="max-w-7xl mx-auto text-center">
			<div class="flex justify-center mb-6">
				<div class="badge badge-primary badge-lg gap-2">
					<Layers size={16} />
					<span>{allMedia.length} items in gallery</span>
				</div>
			</div>
			<h1 class="text-5xl md:text-7xl font-bold text-white mb-6">
				Full Gallery
			</h1>
			<p class="text-xl md:text-2xl text-gray-300 max-w-3xl mx-auto">
				Every frame tells a story. Every moment captured with intention.
				Explore our complete collection of photography and video work.
			</p>
		</div>
	</section>

	<!-- Filter and Grid Section -->
	{
		error ? (
			<section class="relative z-10 py-20 px-6">
				<div class="max-w-7xl mx-auto">
					<div class="alert alert-error">
						<svg
							xmlns="http://www.w3.org/2000/svg"
							class="stroke-current shrink-0 h-6 w-6"
							fill="none"
							viewBox="0 0 24 24"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
							/>
						</svg>
						<span>{error}</span>
					</div>
				</div>
			</section>
		) : (
			<section class="relative z-10 py-12 px-6">
				<div class="max-w-7xl mx-auto">
					<!-- Filter Controls -->
					<div class="sticky top-24 z-20 mb-12 bg-base-100/90 backdrop-blur-xl rounded-3xl border border-white/10 p-6 shadow-2xl">
						<div class="flex flex-col lg:flex-row gap-6 items-start lg:items-center justify-between">
							<!-- Type Filter -->
							<div class="flex flex-col sm:flex-row gap-4 w-full lg:w-auto">
								<div class="form-control">
									<label class="label cursor-pointer gap-3">
										<input
											type="radio"
											name="media-filter"
											class="radio radio-primary"
											value="all"
											checked
											data-filter="all"
										/>
										<span class="label-text text-white flex items-center gap-2">
											<Grid3x3 size={18} />
											All Media ({allMedia.length})
										</span>
									</label>
								</div>
								<div class="form-control">
									<label class="label cursor-pointer gap-3">
										<input
											type="radio"
											name="media-filter"
											class="radio radio-primary"
											value="photography"
											data-filter="photography"
										/>
										<span class="label-text text-white flex items-center gap-2">
											<Image size={18} />
											Photos ({photos.length})
										</span>
									</label>
								</div>
								<div class="form-control">
									<label class="label cursor-pointer gap-3">
										<input
											type="radio"
											name="media-filter"
											class="radio radio-primary"
											value="video"
											data-filter="video"
										/>
										<span class="label-text text-white flex items-center gap-2">
											<Video size={18} />
											Videos ({videos.length})
										</span>
									</label>
								</div>
							</div>

							<!-- Tag Filter -->
							{allTags.length > 0 && (
								<div class="dropdown dropdown-end w-full lg:w-auto">
									<label
										tabindex="0"
										class="btn btn-outline btn-primary w-full lg:w-auto"
									>
										<Layers size={18} />
										Filter by Tag
									</label>
									<ul
										tabindex="0"
										class="dropdown-content z-[1] menu p-2 shadow-xl bg-base-100 rounded-box w-64 max-h-96 overflow-y-auto border border-white/10"
									>
										<li>
											<button data-tag-filter="all" class="active">
												All Tags
											</button>
										</li>
										<li class="menu-title">
											<span>Tags</span>
										</li>
										{allTags.map((tag) => (
											<li>
												<button data-tag-filter={tag}>
													{tag}
												</button>
											</li>
										))}
									</ul>
								</div>
							)}
						</div>

						<!-- Active Filters Display -->
						<div id="active-filters" class="mt-4 hidden">
							<div class="flex flex-wrap gap-2">
								<span class="text-sm text-gray-400">
									Active filters:
								</span>
								<div id="filter-badges" class="flex flex-wrap gap-2" />
							</div>
						</div>
					</div>

					<!-- Media Grid -->
					<div
						id="media-grid"
						class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
					>
						{allMedia.map((item) => (
							<div
								class="media-item transform transition-all duration-300 hover:scale-105"
								data-type={item.type}
								data-tags={JSON.stringify(item.tags || [])}
								data-id={item.id}
							>
								<div class="card bg-base-100 shadow-xl border border-white/10 overflow-hidden group">
									{item.type === "photography" ? (
										<figure class="relative aspect-video overflow-hidden">
											<img
												src={item.url}
												alt={item.title}
												class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
												loading="lazy"
											/>
											<div class="absolute top-4 right-4">
												<div class="badge badge-primary gap-2">
													<Image size={14} />
													Photo
												</div>
											</div>
										</figure>
									) : (
										<figure class="relative aspect-video overflow-hidden bg-black">
											<VideoPlayer
												src={item.url}
												poster={item.thumbnail}
												title={undefined}
												aspectRatio="video"
												autoplay={false}
												controls={true}
												loop={true}
												muted={true}
												showPlayButton={true}
											/>
											<div class="absolute top-4 right-4 z-10">
												<div class="badge badge-secondary gap-2">
													<Video size={14} />
													Video
												</div>
											</div>
										</figure>
									)}

									<div class="card-body p-4">
										<h3 class="card-title text-white text-lg">
											{item.title}
										</h3>
										{item.description && (
											<p class="text-gray-400 text-sm line-clamp-2">
												{item.description}
											</p>
										)}
										{item.tags && item.tags.length > 0 && (
											<div class="flex flex-wrap gap-2 mt-2">
												{item.tags.map((tag) => (
													<span class="badge badge-outline badge-sm">
														{tag}
													</span>
												))}
											</div>
										)}
										<div class="text-xs text-gray-500 mt-2">
											{new Date(
												item.createdAt
											).toLocaleDateString("en-US", {
												year: "numeric",
												month: "short",
												day: "numeric",
											})}
										</div>
									</div>
								</div>
							</div>
						))}
					</div>

					<!-- Empty State -->
					<div
						id="empty-state"
						class="hidden text-center py-20"
					>
						<div class="max-w-md mx-auto">
							<div class="text-6xl mb-4">üîç</div>
							<h3 class="text-2xl font-bold text-white mb-2">
								No results found
							</h3>
							<p class="text-gray-400">
								Try adjusting your filters to see more content.
							</p>
						</div>
					</div>
				</div>
			</section>
		)
	}

	<!-- CTA Section -->
	<section class="relative z-10 py-20 px-6">
		<div class="max-w-4xl mx-auto text-center">
			<div class="card bg-gradient-to-br from-primary/20 to-secondary/20 border border-white/10 backdrop-blur-xl">
				<div class="card-body p-8 md:p-12">
					<h2 class="text-3xl md:text-4xl font-bold text-white mb-4">
						Ready to Create Your Story?
					</h2>
					<p class="text-xl text-gray-300 mb-8">
						Let's collaborate and bring your vision to life through
						stunning visuals and compelling narratives.
					</p>
					<div class="flex flex-col sm:flex-row gap-4 justify-center">
						<a href="/contact" class="btn btn-primary btn-lg">
							Start Your Project
						</a>
						<a
							href="/case-studies"
							class="btn btn-outline btn-primary btn-lg"
						>
							View Case Studies
						</a>
					</div>
				</div>
			</div>
		</div>
	</section>
</RootLayout>

<script>
	// Filter functionality
	function initializeFilters() {
		const mediaItems = document.querySelectorAll(
			".media-item"
		) as NodeListOf<HTMLElement>;
		const typeFilters = document.querySelectorAll(
			'[data-filter]'
		) as NodeListOf<HTMLInputElement>;
		const tagFilters = document.querySelectorAll(
			"[data-tag-filter]"
		) as NodeListOf<HTMLButtonElement>;
		const emptyState = document.getElementById("empty-state");
		const mediaGrid = document.getElementById("media-grid");

		let activeType = "all";
		let activeTag = "all";

		function filterMedia() {
			let visibleCount = 0;

			mediaItems.forEach((item) => {
				const itemType = item.dataset.type;
				const itemTags = JSON.parse(item.dataset.tags || "[]");

				const typeMatch =
					activeType === "all" || itemType === activeType;
				const tagMatch =
					activeTag === "all" || itemTags.includes(activeTag);

				if (typeMatch && tagMatch) {
					item.classList.remove("hidden");
					item.style.display = "block";
					visibleCount++;
				} else {
					item.classList.add("hidden");
					item.style.display = "none";
				}
			});

			// Show/hide empty state
			if (emptyState && mediaGrid) {
				if (visibleCount === 0) {
					mediaGrid.classList.add("hidden");
					emptyState.classList.remove("hidden");
				} else {
					mediaGrid.classList.remove("hidden");
					emptyState.classList.add("hidden");
				}
			}
		}

		// Type filter listeners
		typeFilters.forEach((filter) => {
			filter.addEventListener("change", () => {
				if (filter.checked) {
					activeType = filter.dataset.filter || "all";
					filterMedia();
				}
			});
		});

		// Tag filter listeners
		tagFilters.forEach((filter) => {
			filter.addEventListener("click", () => {
				activeTag = filter.dataset.tagFilter || "all";

				// Update active state
				tagFilters.forEach((f) => f.classList.remove("active"));
				filter.classList.add("active");

				filterMedia();
			});
		});
	}

	// Initialize on page load
	if (document.readyState === "loading") {
		document.addEventListener("DOMContentLoaded", initializeFilters);
	} else {
		initializeFilters();
	}
</script>

<style>
	.media-item {
		will-change: transform;
	}

	@media (prefers-reduced-motion: reduce) {
		.media-item {
			transform: none !important;
			transition: none !important;
		}
	}

	.line-clamp-2 {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
</style>
